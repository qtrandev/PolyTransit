<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/leaflet-map/leaflet-map.html">
<link rel="import" href="../../bower_components/leaflet-map/leaflet-marker.html">
<link rel="import" href="../../bower_components/leaflet-map/leaflet-popup.html">
<link rel="import" href="../../bower_components/leaflet-map/leaflet-layer.html">
<link rel="import" href="../../bower_components/leaflet-map/leaflet-draw.html">
<dom-module id="route-view">
  <style>
    leaflet-map {
      height = 300px;
    }
  </style>
  <template>
    <h1>Route View! <span>{{route}}</span></h1>
    <leaflet-icon
      id="busStopIcon"
      icon-url="http://codeformiami.org/LeafletTransit/icons/icon-Bus-Stop.png"
      icon-width="22"
      icon-height="22"
      icon-anchor-x="11"
      icon-anchor-y="22">
    </leaflet-icon>
    <leaflet-icon
      id="busIcon"
      icon-url="http://codeformiami.org/LeafletTransit/icons/icon-Bus-Tracker.png"
      icon-anchor-x="22"
      icon-anchor-y="22">
    </leaflet-icon>
    <!-- Request live MDT bus locations and then show if match route -->
    <iron-ajax
      auto
      url="http://miami-transit-api.herokuapp.com/api/Buses.json"
      handle-as="json"
      on-response="handleBusesResponse">
    </iron-ajax>
    <iron-ajax
      auto
      url="http://miami-transit-api.herokuapp.com/api/BusRouteStops.json"
      handle-as="json"
      params={{ajaxparams}}
      on-response="handleRouteResponse"
      debounce-duration="300">
    </iron-ajax>
    <iron-ajax
      auto
      url="http://miami-transit-api.herokuapp.com/api/BusRouteShapesByRoute.json"
      handle-as="json"
      params={{ajaxparams}}
      on-response="handleRouteShapeIdResponse"
      debounce-duration="300">
    </iron-ajax>
    <iron-ajax
      auto
      url="http://miami-transit-api.herokuapp.com/api/BusRouteShape.json"
      handle-as="json"
      params={{shapeidparams}}
      on-response="handleRouteShapeResponse"
      debounce-duration="300">
    </iron-ajax>
    <leaflet-map style="height:600px" fit-to-markers latitude="26.023679" longitude="-80.143186" zoom="10">
      <template is="dom-repeat" items="{{stops}}" as="busStop">
        <leaflet-marker
          latitude="[[busStop.Latitude]]"
          longitude="[[busStop.Longitude]]"
          title="[[busStop.StopName]]"
          icon="busStopIcon">
          <b><span>[[busStop.Sequence]]</span> - <span>[[busStop.StopID]]</span>   <span>[[busStop.StopName]]</span></b>
        </leaflet-marker>
      </template>
      <!-- Use circle since leaflet-map polyline is not working -->
      <template is="dom-repeat" items="{{shapes}}" as="shape">
        <leaflet-circle latitude="[[shape.Latitude]]" longitude="[[shape.Longitude]]"
           radius="20" color="#0a0" fillColor="#aa0" fillOpacity="0.5" fill="true"
        </leaflet-circle>
      </template>
      <!-- Show live MDT buses match route if available -->
      <template is="dom-repeat" items="{{buses}}" as="bus">
        <leaflet-marker
          latitude="[[bus.Latitude]]"
          longitude="[[bus.Longitude]]"
          title="[[bus.BusID]]"
          icon="busIcon">
          <b><span>[[bus.RouteID]]</span> <span>[[bus.ServiceDirection]]</span> - <span>[[bus.BusID]]</span> <span>[[bus.BusName]]</span></b>
        </leaflet-marker>
      </template>
    </leaflet-map>
  </template>

  <script>
    Polymer({
      is: "route-view",
      properties: {
        route: {
          type: String
        },
        shapeId: {
          type: String
        },
        ajaxparams: {
          type: Object,
          value: {},
          computed: '_computeParams(route)'
        },
        shapeidparams: {
          type: Object,
          value: {},
          computed: '_computeShapeIdParams(shapeId)'
        },
        buses: {
          type: Array,
          value: []
        }
      },
      _computeParams: function(route) {
        return {
          RouteID: route,
          Dir: 'Northbound'
        };
      },
      _computeShapeIdParams: function(shapeId) {
        return {
          ShapeID: shapeId
        };
      },
      handleRouteResponse: function(e) {
        var object = e.detail.response.RecordSet;
        if (object !== null) {
          this.stops = object.Record;
        }
        else  {
          this.stops = [];
        }
      },
      handleRouteShapeIdResponse: function(e) {
        var object = e.detail.response.RecordSet;
        if (object !== null) {
          this.shapeId = object.Record.ShapeID;
        }
      },
      handleRouteShapeResponse: function(e) {
        var object = e.detail.response.RecordSet;
        if (object !== null) {
          this.shapes = object.Record;
        }
      },
      handleBusesResponse: function(e) {
        var object = e.detail.response.RecordSet;
        if (object !== null) {
          this.buses = [];
          for (var i = 0; i < object.Record.length; i++) {
            if (this.route == object.Record[i].RouteID) {
              this.push('buses', object.Record[i]);
            }
          }
        }
      }
    });
  </script>
</dom-module>
